x---
title: 'human-integrated-datasets-cTECs-analysis'
output: html_document
date: "2026-01-07"
---

```{r setup, include=FALSE}
library(Seurat)
library(ggplot2)
library(SeuratData)
library(readr)
library(dplyr)
library("Seurat")
library("ggplot2")
library("SeuratData")
library("readr")
library("dplyr")
library("viridis")
library("tidyverse")
library("sf")
library("rnaturalearth")
library("RColorBrewer")

all_markers <- read_csv("/Users/vo/projects/heterogeneity_ctec/data/all_markers_updated.csv")
```

```{r}
#Open seurat object
ctecs_obj <- readRDS("/Users/vo/projects/heterogeneity_ctec/data/human_integrated_datasets_updated_all_genes_no_zc_09172025_seu_ctecs.rds")
```

```{r}
ctecs_obj <- FindVariableFeatures(ctecs_obj, selection.method = 'vst', nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(ctecs_obj), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(ctecs_obj)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
```


```{r}
#Initial data processing
assay <- DefaultAssay(ctecs_obj)
#subset rownames to keep only gene names and get rid of the ensembles
rownames(ctecs_obj) <-  sub(".*\\.", "", rownames(ctecs_obj))
new_features <- rownames(ctecs_obj)[!(rownames(ctecs_obj) %in% rownames(ctecs_obj)[duplicated(rownames(ctecs_obj))])]
#head(new_features)
ctecs_obj <- ctecs_obj[new_features,]
cell_label = ctecs_obj@meta.data$celltype_level_3
#scaling the data
ctecs_obj <- ScaleData(ctecs_obj, features = rownames(ctecs_obj))
```

```{r}
#Run initial UMAP and PCA on the cTECs datasets
ctecs_obj <- RunPCA(ctecs_obj, features = VariableFeatures(object = ctecs_obj))
ctecs_obj <- RunUMAP(ctecs_obj, dims = 1:10 )
ctecs_obj <- RunTSNE(object = ctecs_obj, dims.use = 1:43, seed.use = 10, perplexity=30)
```
#Initial data exploration
```{r}
VizDimLoadings(ctecs_obj, dims = 1:2, reduction = "pca")
```

```{r}
top10
top10_cluster0 <- subset(top10, cluster == "0")
top10_cluster0$gene_name <-sub(".*\\.", "", top10_cluster0$gene)
#class(ctecs_obj)
all_markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1)%>%
    slice_head(n=10) %>%
    ungroup() -> top10
top10$gene

top10_cluster0 <- subset(top10, cluster == "0")
top10_cluster0$gene_name <-sub(".*\\.", "", top10_cluster0$gene)
#class(ctecs_obj)
```


```{r}
top10_cluster0$gene_name
#ctecs_obj$gene
VlnPlot(ctecs_obj, features = top10_cluster0$gene_name, slot = "counts", log = TRUE)

top10_cluster1 <- subset(top10, cluster == "1")
top10_cluster1$gene_name <-sub(".*\\.", "", top10_cluster1$gene)
#class(ctecs_obj)
top10_cluster1$gene_name
#ctecs_obj$gene
VlnPlot(ctecs_obj, features = top10_cluster1$gene_name, , slot = "counts", log = TRUE)
```


```{r}
top10_cluster2 <- subset(top10, cluster == "2")
top10_cluster2$gene_name <-sub(".*\\.", "", top10_cluster2$gene)
top10_cluster2$gene_name
VlnPlot(ctecs_obj, features = top10_cluster2$gene_name, , slot = "counts", log = TRUE)
```

```{r}
top10_cluster3 <- subset(top10, cluster == "3")
top10_cluster3$gene_name <-sub(".*\\.", "", top10_cluster3$gene)
top10_cluster3$gene_name
VlnPlot(ctecs_obj, features = top10_cluster3$gene_name, , slot = "counts", log = TRUE)
```

```{r}
top10_cluster2 <- subset(top10, cluster == "2")
top10_cluster2$gene_name <-sub(".*\\.", "", top10_cluster2$gene)
top10_cluster2$gene_name
VlnPlot(ctecs_obj, features = top10_cluster2$gene_name, , slot = "counts", log = TRUE)
```

```{r}
#Pan TEC gene markers
pan_tec <- c("EPCAM", "FOXN1", "KRT8")
#plot Multiple markers
FeaturePlot(ctecs_obj, 
            features = pan_tec,
            ncol = 2,
            pt.size = 0.5)
```

#Look at UMAP of cTEC-specific markers from literature
```{r}
#cTEC-specific markers
ctecs_markers <- c("PSMB11", "PRSS16", "LY75", "IL7", "DLL4", "CXCL12", "CCL25", "LY6A", "CD83","CTSL")
FeaturePlot(ctecs_obj, 
            features = ctecs_markers,
            ncol = 2,
            pt.size = 0.5)
```


```{r} 
#exploration of the primary sources of heterogeneity in a dataset
DimHeatmap(ctecs_obj, dims = 1, cells = 1000, balanced = TRUE)
ctecs_markers <- c("PSMB11", "PRSS16", "LY75", "IL7", "DLL4", "CXCL12", "CCL25", "CD83","CTSL")
ctecs_obj <- UpdateSeuratObject(ctecs_obj)
FeaturePlot(ctecs_obj, 
            features = ctecs_markers,
            ncol = 3,
            pt.size = 0.5)
```

#Data Clustering & annotation for cTECs datasets
```{r}
#Find neighbors
ctecs_obj <-FindNeighbors(ctecs_obj, dims= 1:10)
ctecs_obj <-FindClusters(ctecs_obj, resolution= 0.5)
ctecs_obj <- RunUMAP(ctecs_obj, dims = 1:10)
DimPlot(ctecs_obj, reduction = "umap", label = TRUE)
```
Dimension reduction plots
```{r} 
#Plots
DimHeatmap(ctecs_obj, dims = 1, cells = 1000, balanced = TRUE)

DimPlot(ctecs_obj, reduction = "umap", label = TRUE, pt.size = 0.5, group.by = "celltype_level_3") + NoLegend()
DimPlot(ctecs_obj, cols = viridis(14))

FeaturePlot(ctecs_obj, features = c("PSMB11", "PRSS16", "LY75"),split.by = "celltype_level_3")

```

```{r}
my_colors <- c("#0072B2", "#E69F00")
p1 <- DimPlot(ctecs_obj, group.by = "celltype_level_3", cols = my_colors) + ggtitle("UMAP by Cell Types") 
p2 <- DimPlot(ctecs_obj, group.by = "seurat_clusters", label = TRUE, label.box = FALSE) + ggtitle("UMAP by Cell Clusters") 
combine_UMAP <- p1|p2
ggsave("/Users/vo/projects/heterogeneity_ctec/analyses/combine_UMAP.pdf", combine_UMAP, width = 8, height = 6)

```

```{r}
saveRDS(ctecs_obj, file = "/Users/vo/projects/heterogeneity_ctec/data/human-integrated-datasets-analysis-upstream.rds")
```
