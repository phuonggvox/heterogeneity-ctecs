x---
title: 'human-integrated-datasets-cTECs-analysis'
output: html_document
date: "2026-01-07"
---

```{r setup, include=FALSE}
library(Seurat)
library(ggplot2)
library(SeuratData)
library(readr)
library(dplyr)
```

```{r}
#Open seurat object
ctecs_obj <- readRDS("/Users/vo/projects/heterogeneity_ctec/data/human_integrated_datasets_updated_all_genes_no_zc_09172025_seu_ctecs.rds")
```

```{r}
#head(rownames(ctecs_obj))
#genes_row <- sub(".*\\.", "", rownames(ctecs_obj))
#ctecs_obj_2 <- 
```


```{r}
ctecs_obj <- FindVariableFeatures(ctecs_obj, selection.method = 'vst', nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(ctecs_obj), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(ctecs_obj)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
```

```{r}
assay <- DefaultAssay(ctecs_obj)
rownames(ctecs_obj)

rownames(ctecs_obj) <-  sub(".*\\.", "", rownames(ctecs_obj))
new_features <- rownames(ctecs_obj)[!(rownames(ctecs_obj) %in% rownames(ctecs_obj)[duplicated(rownames(ctecs_obj))])]
ctecs_obj <- ctecs_obj[new_features,]
#all_genes
#head(all.genes)

#scaling the data
ctecs_obj <- ScaleData(ctecs_obj, features = rownames(ctecs_obj))
```


```{r}
#Run initial UMAP and PCA on the cTECs datasets
ctecs_obj <- RunPCA(ctecs_obj, features = VariableFeatures(object = ctecs_obj))
ctecs_obj <- RunUMAP(ctecs_obj, dims = 1:10 )
```

```{r}
VizDimLoadings(ctecs_obj, dims = 1:2, reduction = "pca")
```


```{r} 
#exploration of the primary sources of heterogeneity in a dataset
DimHeatmap(ctecs_obj, dims = 1, cells = 1000, balanced = TRUE)
```
```{r}
#Find neighbors
ctecs_obj <-FindNeighbors(ctecs_obj, dims= 1:10)
ctecs_obj <-FindClusters(ctecs_obj, resolution= 0.5)

#Run UMAP from clusters
ctecs_obj <- RunUMAP(ctecs_obj, dims = 1:10)
DimPlot(ctecs_obj, reduction = "umap", label = TRUE)
```

```{r}
saveRDS(ctecs_obj, file = "/Users/vo/projects/heterogeneity_ctec/data/human-integrated-datasets-analysis.rds")
```
```{r}
install.packages('devtools')
#devtools::install_github('immunogenomics/presto')
#Find all markers for all clusters
#all.markers <- FindAllMarkers(object = ctecs_obj)

#head(x = all.markers)
markers_cluster1 <- FindMarkers(object=ctecs_obj, ident.1 =1)
head(x = markers_cluster1)

```
```{r}
all.markers <- FindAllMarkers(object = ctecs_obj)

```

```{r}
VlnPlot(ctecs_obj, features = c("HBG2","CDKN1C","LINC02605","ENSG00000289474","C3","CDKN1C"))

```

```{r}
all_markers <- read_csv("data/all_markers.csv")
View(all_markers)

#ctecs_pos_markers <- FindAllMarkers(ctecs_obj, only.pos = TRUE)
all_markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1)%>%
    slice_head(n=10) %>%
    ungroup() -> top10
top10
top10_cluster0 <- subset(top10, cluster == "0")
top10_cluster0$gene_name <-sub(".*\\.", "", top10_cluster0$gene)
#class(ctecs_obj)
top10_cluster0$gene_name
#ctecs_obj$gene
VlnPlot(ctecs_obj, features = top10_cluster0$gene_name, slot = "counts", log = TRUE)
```
```{r}
top10_cluster1 <- subset(top10, cluster == "1")
top10_cluster1$gene_name <-sub(".*\\.", "", top10_cluster1$gene)
#class(ctecs_obj)
top10_cluster1$gene_name
#ctecs_obj$gene
VlnPlot(ctecs_obj, features = top10_cluster1$gene_name, , slot = "counts", log = TRUE)
```


```{r}
top10_cluster2 <- subset(top10, cluster == "2")
top10_cluster2$gene_name <-sub(".*\\.", "", top10_cluster2$gene)
top10_cluster2$gene_name
VlnPlot(ctecs_obj, features = top10_cluster2$gene_name, , slot = "counts", log = TRUE)
```

```{r}
DoHeatmap(ctecs_obj, features = top10$gene) + NoLegend()
```

